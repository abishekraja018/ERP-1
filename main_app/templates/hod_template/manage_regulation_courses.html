{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<style>
    .bg-warning-light {
        background-color: #fff3cd !important;
    }
    .course-option.bg-light {
        background-color: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }
    .course-option.bg-light:hover {
        background-color: #ffe69c !important;
    }
</style>
<section class="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-book mr-2"></i>Course Plan for {{ regulation }}
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'manage_regulation' %}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Regulations
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label>Program Type</label>
                                    <select class="form-control" id="globalProgramType">
                                        {% for code, name in program_levels %}
                                        <option value="{{ code }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label>Branch</label>
                                    <select class="form-control" id="globalBranch">
                                        <option value="">-- Select Program First --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <p class="text-muted mb-0">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Select program and branch, then click on any semester to expand and manage courses.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Semester Tiles -->
        <div id="semesterContainer">
            {% for sem_num in semesters %}
            <div class="card card-outline card-secondary semester-card mb-2" data-semester="{{ sem_num }}">
                <div class="card-header py-2" style="cursor: pointer;" data-toggle="collapse" data-target="#semester{{ sem_num }}Content">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt mr-2"></i>Semester {{ sem_num }}
                        <span class="badge badge-primary ml-2 course-count" data-semester="{{ sem_num }}">0 courses</span>
                    </h5>
                    <div class="card-tools">
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div id="semester{{ sem_num }}Content" class="collapse">
                    <div class="card-body">
                        <!-- Quick Add Course for this semester -->
                        <div class="mb-3 p-3 bg-light rounded">
                            <form class="add-course-form" data-semester="{{ sem_num }}">
                                {% csrf_token %}
                                <div class="row align-items-end">
                                    <div class="col-md-3">
                                        <div class="form-group mb-0">
                                            <label class="small">Search Course</label>
                                            <input type="text" class="form-control form-control-sm course-search" 
                                                   placeholder="Type course code or title..." autocomplete="off">
                                            <input type="hidden" class="selected-course-code" required>
                                            <div class="course-dropdown dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-0">
                                            <label class="small">Category</label>
                                            <select class="form-control form-control-sm category-select" required>
                                                <option value="">Select</option>
                                                {% for cat in regulation.course_categories.all %}
                                                <option value="{{ cat.id }}" data-code="{{ cat.code }}">{{ cat.code }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group mb-0">
                                            <div class="custom-control custom-checkbox mt-4">
                                                <input type="checkbox" class="custom-control-input elective-check" id="elective{{ sem_num }}">
                                                <label class="custom-control-label small" for="elective{{ sem_num }}">Elective</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 vertical-field" style="display: none;">
                                        <div class="form-group mb-0">
                                            <label class="small">Vertical 
                                                <a href="#" class="text-primary manage-verticals-link ml-1" title="Manage Verticals" data-toggle="modal" data-target="#manageVerticalsModal">
                                                    <i class="fas fa-cog fa-sm"></i>
                                                </a>
                                            </label>
                                            <select class="form-control form-control-sm elective-vertical-select">
                                                <option value="">-- Select Vertical --</option>
                                                <!-- Options loaded dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-success btn-sm btn-block">
                                            <i class="fas fa-plus mr-1"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Course List for this semester -->
                        <div class="semester-courses" data-semester="{{ sem_num }}">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading courses...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Available Courses Reference -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card card-outline card-dark collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list mr-2"></i>All Available Courses (Reference)
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>L-T-P</th>
                                    <th>Credits</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in available_courses %}
                                <tr>
                                    <td><strong>{{ course.course_code }}</strong></td>
                                    <td>{{ course.title }}</td>
                                    <td>{{ course.get_course_type_display }}</td>
                                    <td>{{ course.ltp_display }}</td>
                                    <td>{{ course.credits }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No courses found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Manage Verticals Modal -->
<div class="modal fade" id="manageVerticalsModal" tabindex="-1" role="dialog" aria-labelledby="manageVerticalsModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="manageVerticalsModalLabel">
                    <i class="fas fa-tags mr-2"></i>Manage Elective Verticals for {{ regulation }}
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Add New Vertical Form -->
                <div class="card card-outline card-success mb-3">
                    <div class="card-header py-2">
                        <h6 class="card-title mb-0"><i class="fas fa-plus mr-1"></i>Add New Vertical</h6>
                    </div>
                    <div class="card-body py-2">
                        <form id="addVerticalForm" class="row align-items-end">
                            {% csrf_token %}
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <label class="small">Vertical Name *</label>
                                    <input type="text" class="form-control form-control-sm" id="newVerticalName" 
                                           placeholder="e.g., Data Science" required>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group mb-0">
                                    <label class="small">Description (optional)</label>
                                    <input type="text" class="form-control form-control-sm" id="newVerticalDesc" 
                                           placeholder="Brief description">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-success btn-sm btn-block">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Existing Verticals List -->
                <div class="card card-outline card-info">
                    <div class="card-header py-2">
                        <h6 class="card-title mb-0"><i class="fas fa-list mr-1"></i>Existing Verticals</h6>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm table-hover mb-0" id="verticalsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Courses</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="verticalsTableBody">
                                <!-- Loaded dynamically -->
                                <tr class="loading-row">
                                    <td colspan="4" class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin"></i> Loading verticals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Vertical Modal -->
<div class="modal fade" id="editVerticalModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-edit mr-2"></i>Edit Vertical</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <form id="editVerticalForm">
                    {% csrf_token %}
                    <input type="hidden" id="editVerticalId">
                    <div class="form-group">
                        <label>Vertical Name *</label>
                        <input type="text" class="form-control" id="editVerticalName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" id="editVerticalDesc">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="saveVerticalEdit">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    const regulationId = {{ regulation.id }};
    let currentProgramType = '';
    let currentBranch = '';
    
    // Toggle icon on collapse
    $('.semester-card .card-header').on('click', function() {
        $(this).find('.toggle-icon').toggleClass('fa-chevron-down fa-chevron-up');
    });
    
    // Function to load programs/branches by level
    function loadProgramsByLevel(level, callback) {
        $.get("{% url 'api_get_programs_by_level' %}", {level: level}, function(data) {
            const select = $('#globalBranch');
            select.empty();
            if (data.programs && data.programs.length > 0) {
                data.programs.forEach(function(program) {
                    const displayText = program.specialization 
                        ? `${program.code} - ${program.specialization}`
                        : program.code;
                    select.append(`<option value="${program.code}">${displayText}</option>`);
                });
                currentBranch = select.val();
            } else {
                select.append('<option value="">No programs found</option>');
            }
            if (callback) callback();
        });
    }
    
    // Load courses for all semesters based on selected program/branch
    function loadAllSemesterCourses() {
        currentProgramType = $('#globalProgramType').val();
        currentBranch = $('#globalBranch').val();
        if (!currentBranch) return;
        {% for sem_num in semesters %}
        loadSemesterCourses({{ sem_num }});
        {% endfor %}
    }
    
    // Load courses for a specific semester
    function loadSemesterCourses(semester) {
        const container = $(`.semester-courses[data-semester="${semester}"]`);
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
        
        $.get("{% url 'api_get_semester_courses' regulation.id %}", {
            semester: semester,
            program_type: currentProgramType,
            branch: currentBranch
        }, function(data) {
            renderSemesterCourses(semester, data.courses || []);
        }).fail(function() {
            container.html('<div class="text-center text-danger py-3">Error loading courses</div>');
        });
    }
    
    // Render courses table for a semester
    function renderSemesterCourses(semester, courses) {
        const container = $(`.semester-courses[data-semester="${semester}"]`);
        const countBadge = $(`.course-count[data-semester="${semester}"]`);
        
        countBadge.text(courses.length + ' course' + (courses.length !== 1 ? 's' : ''));
        
        if (courses.length === 0) {
            container.html(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No courses added for Semester ${semester}</p>
                    <small>Use the form above to add courses</small>
                </div>
            `);
            return;
        }
        
        let html = `
            <table class="table table-sm table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>Course Code</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Credits</th>
                        <th>L-T-P</th>
                        <th>Type</th>
                        <th width="60">Action</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        courses.forEach(function(course) {
            let typeDisplay = '';
            let rowClass = '';
            let codeDisplay = course.course_code;
            
            // Check if it's a placeholder course
            if (course.is_placeholder) {
                rowClass = 'bg-warning-light';
                codeDisplay = `<span class="badge badge-warning mr-1">Placeholder</span>${course.course_code}`;
            }
            
            if (course.is_elective) {
                typeDisplay = '<span class="badge badge-warning">Elective</span>';
                if (course.elective_vertical) {
                    typeDisplay += `<br><small class="text-muted">${course.elective_vertical}</small>`;
                }
            } else {
                typeDisplay = '<span class="badge badge-success">Core</span>';
            }
            
            html += `
                <tr class="${rowClass}">
                    <td><strong>${codeDisplay}</strong></td>
                    <td>${course.title}</td>
                    <td><span class="badge badge-info">${course.category || '-'}</span></td>
                    <td>${course.credits}</td>
                    <td>${course.ltp || '-'}</td>
                    <td>${typeDisplay}</td>
                    <td>
                        <button type="button" class="btn btn-xs btn-danger remove-course" 
                                data-plan-id="${course.plan_id}" data-code="${course.course_code}">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.html(html);
    }
    
    // Program type change handler
    $('#globalProgramType').on('change', function() {
        loadProgramsByLevel($(this).val(), loadAllSemesterCourses);
    });
    
    // Branch change handler
    $('#globalBranch').on('change', loadAllSemesterCourses);
    
    // Initialize on page load
    loadProgramsByLevel($('#globalProgramType').val(), loadAllSemesterCourses);
    
    // Course search functionality
    let searchTimeout = null;
    $(document).on('input', '.course-search', function() {
        const $input = $(this);
        const query = $input.val().trim();
        const $dropdown = $input.siblings('.course-dropdown');
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            $dropdown.removeClass('show').empty();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            $.get("{% url 'api_search_courses' %}", {q: query, regulation_id: regulationId, limit: 10}, function(data) {
                $dropdown.empty();
                if (data.courses && data.courses.length > 0) {
                    data.courses.forEach(function(course) {
                        let displayHtml = '';
                        if (course.is_placeholder) {
                            displayHtml = `
                                <a class="dropdown-item course-option bg-light" href="#" 
                                   data-code="${course.course_code}" data-title="${course.title}"
                                   data-is-placeholder="true" data-placeholder-type="${course.placeholder_type}">
                                    <span class="badge badge-warning mr-1">Placeholder</span>
                                    <strong>${course.course_code}</strong> - ${course.title}
                                    <br><small class="text-muted">${course.credits} cr | ${course.placeholder_type}</small>
                                </a>
                            `;
                        } else {
                            displayHtml = `
                                <a class="dropdown-item course-option" href="#" 
                                   data-code="${course.course_code}" data-title="${course.title}"
                                   data-is-placeholder="false">
                                    <strong>${course.course_code}</strong> - ${course.title}
                                    <br><small class="text-muted">${course.ltp}, ${course.credits} cr</small>
                                </a>
                            `;
                        }
                        $dropdown.append(displayHtml);
                    });
                } else {
                    $dropdown.append('<span class="dropdown-item text-muted">No courses found</span>');
                }
                $dropdown.addClass('show');
            });
        }, 300);
    });
    
    // Select course from dropdown
    $(document).on('click', '.course-option', function(e) {
        e.preventDefault();
        const $option = $(this);
        const $form = $option.closest('.add-course-form');
        $form.find('.selected-course-code').val($option.data('code'));
        $form.find('.course-search').val($option.data('code') + ' - ' + $option.data('title'));
        $option.closest('.course-dropdown').removeClass('show');
    });
    
    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.course-search, .course-dropdown').length) {
            $('.course-dropdown').removeClass('show');
        }
    });
    
    // Show/hide vertical field based on category selection (PEC, OEC, ETC are electives)
    // For elective categories, show auto-assign hint
    $(document).on('change', '.category-select', function() {
        const $form = $(this).closest('.add-course-form');
        const selectedOption = $(this).find('option:selected');
        const categoryCode = selectedOption.data('code');
        const electiveCats = ['PEC', 'OEC', 'ETC', 'SDC', 'SLC', 'IOC', 'AC', 'NCC', 'HON', 'MIN'];
        
        if (electiveCats.includes(categoryCode)) {
            $form.find('.elective-check').prop('checked', true);
            $form.find('.vertical-field').slideDown(200);
            
            // Show hint that slot will be auto-assigned
            const $input = $form.find('.course-search');
            $input.attr('placeholder', `Leave empty to auto-assign next ${categoryCode} slot, or search for specific course`);
            $form.find('.selected-course-code').val(''); // Clear any previous selection
            
        } else {
            $form.find('.elective-check').prop('checked', false);
            $form.find('.vertical-field').slideUp(200);
            $form.find('.elective-vertical-select').val('');
            $form.find('.course-search').attr('placeholder', 'Type course code or title...');
        }
    });
    
    // Show/hide vertical field based on elective checkbox
    $(document).on('change', '.elective-check', function() {
        const $form = $(this).closest('.add-course-form');
        if ($(this).is(':checked')) {
            $form.find('.vertical-field').slideDown(200);
        } else {
            $form.find('.vertical-field').slideUp(200);
            $form.find('.elective-vertical-select').val('');
        }
    });
    
    // Add course form submission
    $(document).on('submit', '.add-course-form', function(e) {
        e.preventDefault();
        const $form = $(this);
        const semester = $form.data('semester');
        const courseCode = $form.find('.selected-course-code').val();
        const category = $form.find('.category-select').val();
        const categoryCode = $form.find('.category-select option:selected').data('code');
        const isElective = $form.find('.elective-check').is(':checked');
        const electiveVerticalId = $form.find('.elective-vertical-select').val();
        
        // Categories that support auto-placeholder
        const autoPlaceholderCats = ['PEC', 'OEC', 'ETC', 'SDC', 'SLC', 'IOC', 'AC', 'NCC', 'HON', 'MIN'];
        const useAutoPlaceholder = autoPlaceholderCats.includes(categoryCode) && !courseCode;
        
        if (!useAutoPlaceholder && !courseCode) { 
            alert('Please select a course from the dropdown'); 
            return; 
        }
        if (!category) { alert('Please select a category'); return; }
        
        $.post("{% url 'api_add_regulation_course' regulation.id %}", {
            course_code: courseCode,
            semester: semester,
            category: category,
            program_type: currentProgramType,
            branch: currentBranch,
            is_elective: isElective ? '1' : '0',
            elective_vertical: electiveVerticalId,
            auto_placeholder: useAutoPlaceholder ? '1' : '0',
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                $form.find('.course-search').val('');
                $form.find('.selected-course-code').val('');
                $form.find('.category-select').val('');
                $form.find('.elective-check').prop('checked', false);
                $form.find('.elective-vertical-select').val('');
                $form.find('.vertical-field').hide();
                loadSemesterCourses(semester);
            } else {
                alert(data.error || 'Error adding course');
            }
        }).fail(function() {
            alert('Error adding course. Please try again.');
        });
    });
    
    // Remove course
    $(document).on('click', '.remove-course', function() {
        const $btn = $(this);
        const planId = $btn.data('plan-id');
        const code = $btn.data('code');
        const semester = $btn.closest('.semester-courses').data('semester');
        
        if (!confirm(`Remove ${code} from the course plan?`)) return;
        
        $.post("{% url 'api_remove_regulation_course' %}", {
            plan_id: planId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                loadSemesterCourses(semester);
            } else {
                alert(data.error || 'Error removing course');
            }
        }).fail(function() {
            alert('Error removing course. Please try again.');
        });
    });
    
    // =============================================================================
    // ELECTIVE VERTICAL MANAGEMENT
    // =============================================================================
    
    // Load verticals into all select dropdowns
    function loadVerticalsIntoSelects() {
        $.get("{% url 'api_get_elective_verticals' regulation.id %}", function(data) {
            const verticals = data.verticals || [];
            // Update all vertical select dropdowns
            $('.elective-vertical-select').each(function() {
                const $select = $(this);
                const currentVal = $select.val();
                $select.find('option:not(:first)').remove();
                verticals.forEach(function(v) {
                    $select.append(`<option value="${v.id}">${v.name}</option>`);
                });
                if (currentVal) $select.val(currentVal);
            });
        });
    }
    
    // Load verticals on page load
    loadVerticalsIntoSelects();
    
    // Load verticals into modal table
    function loadVerticalsTable() {
        const $tbody = $('#verticalsTableBody');
        $tbody.html('<tr class="loading-row"><td colspan="4" class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');
        
        $.get("{% url 'api_get_elective_verticals' regulation.id %}", function(data) {
            const verticals = data.verticals || [];
            $tbody.empty();
            
            if (verticals.length === 0) {
                $tbody.html('<tr><td colspan="4" class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2 d-block"></i>No verticals defined yet<br><small>Add your first vertical above</small></td></tr>');
                return;
            }
            
            verticals.forEach(function(v) {
                const canDelete = v.course_count === 0;
                $tbody.append(`
                    <tr data-id="${v.id}">
                        <td><strong>${v.name}</strong></td>
                        <td class="text-muted">${v.description || '-'}</td>
                        <td><span class="badge badge-info">${v.course_count}</span></td>
                        <td>
                            <button type="button" class="btn btn-xs btn-warning edit-vertical" 
                                    data-id="${v.id}" data-name="${v.name}" data-desc="${v.description || ''}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-xs btn-danger delete-vertical ${canDelete ? '' : 'disabled'}" 
                                    data-id="${v.id}" data-name="${v.name}" ${canDelete ? '' : 'disabled'} 
                                    title="${canDelete ? 'Delete' : 'Cannot delete - has assigned courses'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        }).fail(function() {
            $tbody.html('<tr><td colspan="4" class="text-center text-danger py-3">Error loading verticals</td></tr>');
        });
    }
    
    // Load verticals when modal opens
    $('#manageVerticalsModal').on('show.bs.modal', function() {
        loadVerticalsTable();
    });
    
    // Add new vertical
    $('#addVerticalForm').on('submit', function(e) {
        e.preventDefault();
        const name = $('#newVerticalName').val().trim();
        const desc = $('#newVerticalDesc').val().trim();
        
        if (!name) { alert('Please enter a vertical name'); return; }
        
        $.post("{% url 'api_add_elective_vertical' regulation.id %}", {
            name: name,
            description: desc,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                $('#newVerticalName').val('');
                $('#newVerticalDesc').val('');
                loadVerticalsTable();
                loadVerticalsIntoSelects();
            } else {
                alert(data.error || 'Error adding vertical');
            }
        }).fail(function() {
            alert('Error adding vertical. Please try again.');
        });
    });
    
    // Open edit modal
    $(document).on('click', '.edit-vertical', function() {
        const $btn = $(this);
        $('#editVerticalId').val($btn.data('id'));
        $('#editVerticalName').val($btn.data('name'));
        $('#editVerticalDesc').val($btn.data('desc'));
        $('#editVerticalModal').modal('show');
    });
    
    // Save vertical edit
    $('#saveVerticalEdit').on('click', function() {
        const id = $('#editVerticalId').val();
        const name = $('#editVerticalName').val().trim();
        const desc = $('#editVerticalDesc').val().trim();
        
        if (!name) { alert('Please enter a vertical name'); return; }
        
        $.post(`/api/vertical/${id}/edit/`, {
            name: name,
            description: desc,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                $('#editVerticalModal').modal('hide');
                loadVerticalsTable();
                loadVerticalsIntoSelects();
            } else {
                alert(data.error || 'Error updating vertical');
            }
        }).fail(function() {
            alert('Error updating vertical. Please try again.');
        });
    });
    
    // Delete vertical
    $(document).on('click', '.delete-vertical:not(.disabled)', function() {
        const $btn = $(this);
        const id = $btn.data('id');
        const name = $btn.data('name');
        
        if (!confirm(`Delete vertical "${name}"?`)) return;
        
        $.post(`/api/vertical/${id}/delete/`, {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                loadVerticalsTable();
                loadVerticalsIntoSelects();
            } else {
                alert(data.error || 'Error deleting vertical');
            }
        }).fail(function() {
            alert('Error deleting vertical. Please try again.');
        });
    });
});
</script>
{% endblock custom_js %}
