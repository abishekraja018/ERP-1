{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<style>
    .bg-warning-light {
        background-color: #fff3cd !important;
    }
    .course-option.bg-light {
        background-color: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }
    .course-option.bg-light:hover {
        background-color: #ffe69c !important;
    }
</style>
<section class="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-book mr-2"></i>Course Plan for {{ regulation }}
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'manage_regulation' %}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Regulations
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label>Program Type</label>
                                    <select class="form-control" id="globalProgramType">
                                        {% for code, name in program_levels %}
                                        <option value="{{ code }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label>Branch</label>
                                    <select class="form-control" id="globalBranch">
                                        <option value="">-- Select Program First --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <p class="text-muted mb-0">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Select program and branch, then click on any semester to expand and manage courses.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Semester Tiles -->
        <div id="semesterContainer">
            {% for sem_num in semesters %}
            <div class="card card-outline card-secondary semester-card mb-2" data-semester="{{ sem_num }}">
                <div class="card-header py-2" style="cursor: pointer;" data-toggle="collapse" data-target="#semester{{ sem_num }}Content">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-alt mr-2"></i>Semester {{ sem_num }}
                        <span class="badge badge-primary ml-2 course-count" data-semester="{{ sem_num }}">0 courses</span>
                    </h5>
                    <div class="card-tools">
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                </div>
                <div id="semester{{ sem_num }}Content" class="collapse">
                    <div class="card-body">
                        <!-- Quick Add Course for this semester -->
                        <div class="mb-3 p-3 bg-light rounded">
                            <form class="add-course-form" data-semester="{{ sem_num }}">
                                {% csrf_token %}
                                <div class="row align-items-end">
                                    <div class="col-md-5">
                                        <div class="form-group mb-0">
                                            <label class="small">Search Course</label>
                                            <input type="text" class="form-control form-control-sm course-search" 
                                                   placeholder="Type course code or title..." autocomplete="off">
                                            <input type="hidden" class="selected-course-code" required>
                                            <div class="course-dropdown dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group mb-0">
                                            <label class="small">Category</label>
                                            <select class="form-control form-control-sm category-select" required>
                                                <option value="">Select</option>
                                                {% for cat in regulation.course_categories.all %}
                                                <option value="{{ cat.id }}" data-code="{{ cat.code }}">{{ cat.code }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2 credits-field" style="display: none;">
                                        <div class="form-group mb-0">
                                            <label class="small">Credits</label>
                                            <input type="number" class="form-control form-control-sm credits-input" 
                                                   min="1" max="10" value="3" placeholder="Credits">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-success btn-sm btn-block">
                                            <i class="fas fa-plus mr-1"></i> Add
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Course List for this semester -->
                        <div class="semester-courses" data-semester="{{ sem_num }}">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading courses...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Available Courses Reference -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card card-outline card-dark collapsed-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list mr-2"></i>All Available Courses (Reference)
                        </h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>L-T-P</th>
                                    <th>Credits</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in available_courses %}
                                <tr>
                                    <td><strong>{{ course.course_code }}</strong></td>
                                    <td>{{ course.title }}</td>
                                    <td>{{ course.get_course_type_display }}</td>
                                    <td>{{ course.ltp_display }}</td>
                                    <td>{{ course.credits }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No courses found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    const regulationId = {{ regulation.id }};
    let currentProgramType = '';
    let currentBranch = '';
    let programsData = {};  // Store programs data including total_semesters
    
    // Toggle icon on collapse
    $('.semester-card .card-header').on('click', function() {
        $(this).find('.toggle-icon').toggleClass('fa-chevron-down fa-chevron-up');
    });
    
    // Function to load programs/branches by level
    function loadProgramsByLevel(level, callback) {
        $.get("{% url 'api_get_programs_by_level' %}", {level: level}, function(data) {
            const select = $('#globalBranch');
            select.empty();
            programsData = {};  // Reset programs data
            if (data.programs && data.programs.length > 0) {
                data.programs.forEach(function(program) {
                    const displayText = program.specialization 
                        ? `${program.code} - ${program.specialization}`
                        : program.code;
                    select.append(`<option value="${program.code}" data-semesters="${program.total_semesters}">${displayText}</option>`);
                    programsData[program.code] = program;
                });
                currentBranch = select.val();
                updateVisibleSemesters();  // Update visible semesters based on selected program
            } else {
                select.append('<option value="">No programs found</option>');
            }
            if (callback) callback();
        });
    }
    
    // Function to show/hide semester cards based on program's total_semesters
    function updateVisibleSemesters() {
        const selectedBranch = $('#globalBranch').val();
        const program = programsData[selectedBranch];
        const totalSemesters = program ? program.total_semesters : 8;
        
        $('.semester-card').each(function() {
            const semNum = parseInt($(this).data('semester'));
            if (semNum <= totalSemesters) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }
    
    // Load courses for all semesters based on selected program/branch
    function loadAllSemesterCourses() {
        currentProgramType = $('#globalProgramType').val();
        currentBranch = $('#globalBranch').val();
        if (!currentBranch) return;
        
        // Only load courses for visible semesters
        const program = programsData[currentBranch];
        const totalSemesters = program ? program.total_semesters : 8;
        for (let sem = 1; sem <= totalSemesters; sem++) {
            loadSemesterCourses(sem);
        }
    }
    
    // Load courses for a specific semester
    function loadSemesterCourses(semester) {
        const container = $(`.semester-courses[data-semester="${semester}"]`);
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading...</div>');
        
        $.get("{% url 'api_get_semester_courses' regulation.id %}", {
            semester: semester,
            program_type: currentProgramType,
            branch: currentBranch
        }, function(data) {
            renderSemesterCourses(semester, data.courses || []);
        }).fail(function() {
            container.html('<div class="text-center text-danger py-3">Error loading courses</div>');
        });
    }
    
    // Render courses table for a semester
    function renderSemesterCourses(semester, courses) {
        const container = $(`.semester-courses[data-semester="${semester}"]`);
        const countBadge = $(`.course-count[data-semester="${semester}"]`);
        
        countBadge.text(courses.length + ' course' + (courses.length !== 1 ? 's' : ''));
        
        if (courses.length === 0) {
            container.html(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No courses added for Semester ${semester}</p>
                    <small>Use the form above to add courses</small>
                </div>
            `);
            return;
        }
        
        let html = `
            <table class="table table-sm table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>Course Code</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Credits</th>
                        <th>L-T-P</th>
                        <th>Type</th>
                        <th width="60">Action</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        courses.forEach(function(course) {
            let typeDisplay = '';
            let rowClass = '';
            let codeDisplay = course.course_code;
            
            // Check if it's a placeholder course
            if (course.is_placeholder) {
                rowClass = 'bg-warning-light';
                codeDisplay = `<span class="badge badge-warning mr-1">Placeholder</span>${course.course_code}`;
            }
            
            if (course.is_elective) {
                typeDisplay = '<span class="badge badge-warning">Elective</span>';
                if (course.elective_vertical) {
                    typeDisplay += `<br><small class="text-muted">${course.elective_vertical}</small>`;
                }
            } else {
                typeDisplay = '<span class="badge badge-success">Core</span>';
            }
            
            html += `
                <tr class="${rowClass}">
                    <td><strong>${codeDisplay}</strong></td>
                    <td>${course.title}</td>
                    <td><span class="badge badge-info">${course.category || '-'}</span></td>
                    <td>${course.credits}</td>
                    <td>${course.ltp || '-'}</td>
                    <td>${typeDisplay}</td>
                    <td>
                        <button type="button" class="btn btn-xs btn-danger remove-course" 
                                data-plan-id="${course.plan_id}" data-code="${course.course_code}">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        container.html(html);
    }
    
    // Program type change handler
    $('#globalProgramType').on('change', function() {
        loadProgramsByLevel($(this).val(), loadAllSemesterCourses);
    });
    
    // Branch change handler
    $('#globalBranch').on('change', function() {
        updateVisibleSemesters();
        loadAllSemesterCourses();
    });
    
    // Initialize on page load
    loadProgramsByLevel($('#globalProgramType').val(), loadAllSemesterCourses);
    
    // Course search functionality
    let searchTimeout = null;
    $(document).on('input', '.course-search', function() {
        const $input = $(this);
        const query = $input.val().trim();
        const $dropdown = $input.siblings('.course-dropdown');
        
        if (searchTimeout) clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            $dropdown.removeClass('show').empty();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            $.get("{% url 'api_search_courses' %}", {q: query, regulation_id: regulationId, limit: 10}, function(data) {
                $dropdown.empty();
                if (data.courses && data.courses.length > 0) {
                    data.courses.forEach(function(course) {
                        let displayHtml = '';
                        if (course.is_placeholder) {
                            displayHtml = `
                                <a class="dropdown-item course-option bg-light" href="#" 
                                   data-code="${course.course_code}" data-title="${course.title}"
                                   data-is-placeholder="true" data-placeholder-type="${course.placeholder_type}">
                                    <span class="badge badge-warning mr-1">Placeholder</span>
                                    <strong>${course.course_code}</strong> - ${course.title}
                                    <br><small class="text-muted">${course.credits} cr | ${course.placeholder_type}</small>
                                </a>
                            `;
                        } else {
                            displayHtml = `
                                <a class="dropdown-item course-option" href="#" 
                                   data-code="${course.course_code}" data-title="${course.title}"
                                   data-is-placeholder="false">
                                    <strong>${course.course_code}</strong> - ${course.title}
                                    <br><small class="text-muted">${course.ltp}, ${course.credits} cr</small>
                                </a>
                            `;
                        }
                        $dropdown.append(displayHtml);
                    });
                } else {
                    $dropdown.append('<span class="dropdown-item text-muted">No courses found</span>');
                }
                $dropdown.addClass('show');
            });
        }, 300);
    });
    
    // Select course from dropdown
    $(document).on('click', '.course-option', function(e) {
        e.preventDefault();
        const $option = $(this);
        const $form = $option.closest('.add-course-form');
        $form.find('.selected-course-code').val($option.data('code'));
        $form.find('.course-search').val($option.data('code') + ' - ' + $option.data('title'));
        $option.closest('.course-dropdown').removeClass('show');
    });
    
    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.course-search, .course-dropdown').length) {
            $('.course-dropdown').removeClass('show');
        }
    });
    
    // Update placeholder hint for elective categories and show/hide credits field
    $(document).on('change', '.category-select', function() {
        const $form = $(this).closest('.add-course-form');
        const selectedOption = $(this).find('option:selected');
        const categoryCode = selectedOption.data('code');
        const electiveCats = ['PEC', 'OEC', 'ETC', 'SDC', 'SLC', 'IOC', 'AC', 'NCC', 'HON', 'MIN'];
        
        const $input = $form.find('.course-search');
        const $creditsField = $form.find('.credits-field');
        
        if (electiveCats.includes(categoryCode)) {
            // Show hint that slot will be auto-assigned for elective categories
            $input.attr('placeholder', `Leave empty to auto-assign next ${categoryCode} slot, or search for specific course`);
            $form.find('.selected-course-code').val(''); // Clear any previous selection
            // Show credits field for placeholder courses
            $creditsField.slideDown(200);
            // Set default credits based on category
            const defaultCredits = ['SLC', 'AC'].includes(categoryCode) ? 1 : 3;
            $form.find('.credits-input').val(defaultCredits);
        } else {
            $input.attr('placeholder', 'Type course code or title...');
            $creditsField.slideUp(200);
        }
    });
    
    // Add course form submission
    $(document).on('submit', '.add-course-form', function(e) {
        e.preventDefault();
        const $form = $(this);
        const semester = $form.data('semester');
        const courseCode = $form.find('.selected-course-code').val();
        const category = $form.find('.category-select').val();
        const categoryCode = $form.find('.category-select option:selected').data('code');
        const credits = $form.find('.credits-input').val() || 3;
        
        // Determine if elective based on category
        const electiveCats = ['PEC', 'OEC', 'ETC', 'SDC', 'SLC', 'IOC', 'AC', 'NCC', 'HON', 'MIN'];
        const isElective = electiveCats.includes(categoryCode);
        
        // Categories that support auto-placeholder
        const autoPlaceholderCats = ['PEC', 'OEC', 'ETC', 'SDC', 'SLC', 'IOC', 'AC', 'NCC', 'HON', 'MIN'];
        const useAutoPlaceholder = autoPlaceholderCats.includes(categoryCode) && !courseCode;
        
        if (!useAutoPlaceholder && !courseCode) { 
            alert('Please select a course from the dropdown'); 
            return; 
        }
        if (!category) { alert('Please select a category'); return; }
        
        $.post("{% url 'api_add_regulation_course' regulation.id %}", {
            course_code: courseCode,
            semester: semester,
            category: category,
            program_type: currentProgramType,
            branch: currentBranch,
            is_elective: isElective ? '1' : '0',
            auto_placeholder: useAutoPlaceholder ? '1' : '0',
            credits: credits,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                $form.find('.course-search').val('').attr('placeholder', 'Type course code or title...');
                $form.find('.selected-course-code').val('');
                $form.find('.category-select').val('');
                $form.find('.credits-field').hide();
                $form.find('.credits-input').val(3);
                loadSemesterCourses(semester);
            } else {
                alert(data.error || 'Error adding course');
            }
        }).fail(function() {
            alert('Error adding course. Please try again.');
        });
    });
    
    // Remove course
    $(document).on('click', '.remove-course', function() {
        const $btn = $(this);
        const planId = $btn.data('plan-id');
        const code = $btn.data('code');
        const semester = $btn.closest('.semester-courses').data('semester');
        
        if (!confirm(`Remove ${code} from the course plan?`)) return;
        
        $.post("{% url 'api_remove_regulation_course' %}", {
            plan_id: planId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data) {
            if (data.success) {
                loadSemesterCourses(semester);
            } else {
                alert(data.error || 'Error removing course');
            }
        }).fail(function() {
            alert('Error removing course. Please try again.');
        });
    });
});
</script>
{% endblock custom_js %}
