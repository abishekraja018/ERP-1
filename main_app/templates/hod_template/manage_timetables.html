{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-calendar-alt mr-2"></i>{{ page_title }}</h3>
                        <div class="card-tools">
                            <a href="{% url 'manage_time_slots' %}" class="btn btn-secondary btn-sm mr-2">
                                <i class="fas fa-clock mr-1"></i> Manage Time Slots
                            </a>
                            <a href="{% url 'add_timetable' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus mr-1"></i> Create Timetable
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-filter mr-2"></i>Filters</h3>
                    </div>
                    <div class="card-body">
                        <form method="GET" class="row">
                            <div class="col-md-3">
                                <label>Academic Year</label>
                                <select name="academic_year" class="form-control">
                                    <option value="">All Academic Years</option>
                                    {% for ay in academic_years %}
                                    <option value="{{ ay.id }}" {% if request.GET.academic_year == ay.id|stringformat:"i" %}selected{% endif %}>{{ ay.year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Year</label>
                                <select name="year" class="form-control">
                                    <option value="">All Years</option>
                                    {% for val, label in year_choices %}
                                    <option value="{{ val }}" {% if request.GET.year == val|stringformat:"i" %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Batch</label>
                                <select name="batch" class="form-control">
                                    <option value="">All Batches</option>
                                    {% for val, label in batch_choices %}
                                    <option value="{{ val }}" {% if request.GET.batch == val %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary mr-2">
                                    <i class="fas fa-search mr-1"></i> Filter
                                </button>
                                <a href="{% url 'manage_timetables' %}" class="btn btn-secondary">
                                    <i class="fas fa-times mr-1"></i> Clear
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timetable List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        {% if timetables %}
                        <table class="table table-bordered table-striped" id="timetable-table">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Academic Year</th>
                                    <th>Semester</th>
                                    <th>Year</th>
                                    <th>Batch</th>
                                    <th>Regulation</th>
                                    <th>Effective From</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tt in timetables %}
                                <tr>
                                    <td>{{ tt.academic_year.year }}</td>
                                    <td>Semester {{ tt.semester.semester_number }}</td>
                                    <td>Year {{ tt.year }}</td>
                                    <td><span class="badge badge-info">{{ tt.batch }}</span></td>
                                    <td>{{ tt.regulation|default:"-" }}</td>
                                    <td>{{ tt.effective_from|date:"d M Y" }}</td>
                                    <td>
                                        {% if tt.is_active %}
                                        <span class="badge badge-success">Active</span>
                                        {% else %}
                                        <span class="badge badge-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'view_timetable' tt.id %}" class="btn btn-info btn-sm" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'edit_timetable' tt.id %}" class="btn btn-primary btn-sm" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_timetable' tt.id %}" class="btn btn-danger btn-sm" title="Delete" 
                                           onclick="return confirm('Are you sure you want to delete this timetable?');">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i>
                            No timetables found. <a href="{% url 'add_timetable' %}">Create a new timetable</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    $('#timetable-table').DataTable({
        "pageLength": 25,
        "order": [[0, "desc"], [2, "asc"], [3, "asc"]]
    });
});
</script>
{% endblock custom_js %}
